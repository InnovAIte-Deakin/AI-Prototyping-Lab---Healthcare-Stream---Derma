name: Playwright Tests

on:
  workflow_dispatch:


jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # --- Backend Setup ---
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install Backend Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt

    - name: Seed Database
      run: |
        cd backend
        python -m app.seed_data
        python -m app.seed_e2e_fixtures
      env:
        DATABASE_URL: sqlite:///./derma.db
        MOCK_AI: "true"

    - name: Start Backend
      run: |
        cd backend
        uvicorn app.main:app --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
      env:
        DATABASE_URL: sqlite:///./derma.db
        MOCK_AI: "true"

    # --- Frontend Setup ---
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: lts/*

    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci

    - name: Install Playwright Browsers
      run: |
        cd frontend
        npx playwright install --with-deps

    - name: Start Frontend
      run: |
        cd frontend
        npm run dev -- --port 5173 &

    # --- Wait for Services (using healthcheck) ---
    - name: Wait for Backend
      run: |
        echo "Waiting for backend to be ready..."
        for i in {1..30}; do
          if curl -sf http://localhost:8000/health; then
            echo "Backend is ready!"
            break
          fi
          echo "Attempt $i: Backend not ready, waiting..."
          sleep 2
        done
        # Extra wait to ensure WebSocket is ready
        sleep 3
        echo "Backend health check complete"

    - name: Wait for Frontend
      run: |
        until curl -sf http://localhost:5173; do sleep 1; done

    # --- Run Diagnostic Test First ---
    - name: Run WebSocket Diagnostic
      run: |
        cd frontend
        npx playwright test ws-diagnostic --reporter=list
      env:
        BASE_URL: http://localhost:5173
        CI: true
      continue-on-error: true

    # --- Run Main Tests ---
    - name: Run Playwright tests
      run: |
        cd frontend
        npx playwright test --ignore-snapshots
      env:
        BASE_URL: http://localhost:5173
        CI: true

    # --- Debug Info (on failure) ---
    - name: Debug Info
      if: failure()
      run: |
        echo "=== Environment ==="
        echo "DATABASE_URL: $DATABASE_URL"
        echo "BASE_URL: $BASE_URL"
        echo "=== Backend Logs ==="
        cat backend/uvicorn.log 2>/dev/null || echo "No backend log found"
        echo "=== Check Services ==="
        curl -s http://localhost:8000/health || echo "Backend not responding"
        curl -s http://localhost:5173 | head -20 || echo "Frontend not responding"
      env:
        DATABASE_URL: sqlite:///./derma.db
        BASE_URL: http://localhost:5173

    # --- Artifacts ---
    - name: Upload Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: frontend/playwright-report/
        retention-days: 30

    - name: Upload Test Results (traces, videos, screenshots)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-results
        path: frontend/test-results/
        retention-days: 7
